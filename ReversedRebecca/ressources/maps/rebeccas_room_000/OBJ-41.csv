TIME -> 1 = GOTO -> TA_INIT, DISABLE_ONTHESPOT:2


//// SET UP ////

$ -> TA_INIT = TRIPLE_ACTION -> OPEN*TALK_DOOR_MISSING_KEY
$ -> TA_NULL = TRIPLE_ACTION -> NULL


//// MISSING KEY ////

$ -> TALK_DOOR_MISSING_KEY = GOTO -> MEMORY:KEY_LOST, TALK:DOOR_MISSING_KEY
TALKED -> DOOR_MISSING_KEY = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS
! -> SEARCH_FOR_KEY = TALK -> DOOR_SEARCH
TALKED -> DOOR_SEARCH = GOTO -> AFFECTING:SEARCHING_KEY, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS
$ -> THINK_ABOUT_LAST_KEY_POS = AFFECTING -> THINK_ABOUT_LAST_KEY_POS
! -> THINK_ABOUT_LAST_KEY_POS = GOTO -> TA_NULL, MEMORY:KNOWING_KEY_POS, AFFECTING:KNOWING_KEY_POS, TALK:DOOR_THINK


//// FOUND KEY ////

! -> FAST_EXIT_POSSIBILITY =  WAITFOR -> TIMER:20 ? MEMORY:ACTIVATED_RIGHT_HAND_ADVISE
UNLOCKEDTOOL -> KEY:RED = GOTO -> MEMORY:KEY_FOUND, ENABLE_ONTHESPOT:2
UNLOCKEDTOOL -> KEY:CYAN = GOTO -> MEMORY:KEY_FOUND, ACTIVATED_RIGHT_HAND_ADVISE_CONDITIONNAL
$ -> ACTIVATED_RIGHT_HAND_ADVISE_CONDITIONNAL = MEMORY -> ACTIVATED_RIGHT_HAND_ADVISE ? PARSE_MUCH_LATER / ENABLE_ONTHESPOT:2, TA_NULL
$ -> PARSE_MUCH_LATER = MEMORY -> DOOR_MUCH_LATER ? TA_RIGHT_HAND / PARSE_BEFORE_VISIT
$ -> PARSE_BEFORE_VISIT = MEMORY -> VISITED ? AFFECTING:SOMEONE_JUST_KNOCKED / TA_RIGHT_HAND
$ -> TA_RIGHT_HAND = TRIPLE_ACTION -> OPEN*TALK_DOOR_RIGHT_HAND
$ -> TALK_DOOR_RIGHT_HAND = TALK -> DOOR_RIGHT_HAND
TALKED -> DOOR_RIGHT_HAND = GOTO -> ENABLE_ONTHESPOT:2, FACING_PLAYER:UP, OPEN_DOOR
$ -> OPEN_DOOR = OPEN_PUZZLE -> 6-1,1
WONPUZZLE -> 6-1 = GOTO -> TA_GO_TO_WORK, MEMORY:DOOR_OPENED, SARAH_ENTER_CONDITIONNAL
$ -> TA_GO_TO_WORK = TRIPLE_ACTION -> GO_TO_WORK*GO_TO_WORK_CONDITIONAL
$ -> SARAH_ENTER_CONDITIONNAL = MEMORY -> SARAH_WAITING_OUTSIDE ? DOOR_IS_OPEN / NULL


//// REBECCA TOWEL ////

! -> NAME_PLAYER_REBECCA_TOWEL = NAME -> REBECCA_TOWEL_DOOR
! -> NAME_PLAYER_REBECCA = NAME -> REBECCA_TOWEL_DOOR ? READY_TO_GO / NULL
$ -> READY_TO_GO = GOTO -> NAME:REBECCA_DOOR, ACTION_GO_TO_WORK
$ -> GO_TO_WORK_CONDITIONAL = NAME -> REBECCA_TOWEL_DOOR ? TALK:GO_TO_WORK_TOWEL / GOTO_WORK


//// SOMEONE KNOCKED ////

! -> SOMEONE_JUST_KNOCKED = GOTO -> DISABLE_ONTHESPOT:2, A1_OPEN_TO_SOMEONE_CONDITIONAL, PARSE_WHOS_THERE_ACTION
$ -> PARSE_WHOS_THERE_ACTION = MEMORY -> SARAH_WAITING_OUTSIDE ? NULL / ACTION_TWO:WHOS_THERE*WHOS_THERE_CONDITIONAL
$ -> A1_OPEN_TO_SOMEONE_CONDITIONAL = MEMORY -> DOOR_OPENED ? ACTION_ONE:OPEN*DOOR_IS_OPEN / DOOR_I_OPENING
$ -> DOOR_I_OPENING = MEMORY -> KEY_FOUND ? ACTION_ONE:OPEN*TALK_DOOR_I_OPENING / DOOR_JUST_A_MOMENT
$ -> DOOR_JUST_A_MOMENT = MEMORY -> KEY_LOST ? ACTION_ONE:JUST_A_MOMENT*TALK_JUST_A_MOMENT / ACTION_ONE:OPEN*TALK_DOOR_FAKE_OPEN

$ -> WHOS_THERE_CONDITIONAL = MEMORY -> DOOR_OPENED ? WHOS_THERE_DOOR_OPEN / WHOS_THERE_DOOR_I_OPENING_CONDITIONAL
$ -> WHOS_THERE_DOOR_I_OPENING_CONDITIONAL = MEMORY -> KEY_FOUND ? WHOS_THERE_DOOR_I_OPENING / WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONAL
$ -> WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONAL = MEMORY -> KEY_LOST ? WHOS_THERE_DOOR_JUST_A_MOMENT / WHOS_THERE_DOOR_FAKE


//// OPEN DOOR ////

$ -> DOOR_IS_OPEN = GOTO -> CUTSCENE:START, TA_GO_TO_WORK, PLAYER_SIDE_STEP
$ -> PLAYER_SIDE_STEP = GOTO -> AFFECTING:SARAH_STOP_KNOCKING, FACING_PLAYER:UP, WAITING_BEFORE_SIDE_STEP
$ -> WAITING_BEFORE_SIDE_STEP = WAITFOR -> TIMER:1 ? AFFECTING:MOVE_PLAYER_TO_SIDE_STEP_ENTRANCE
! -> PLAYER_REACHED_SIDE_STEP_ENTRANCE = WAITFOR -> TIMER:1 ? PARSE_DODGED_HUG 
$ -> PARSE_DODGED_HUG = MEMORY -> SARAH_ENTERED ? NULL / TALK:DOOR_IS_OPEN, BLOCKING_PATH:FALSE, AFFECTING:SARAH_ENTER
! -> BLOCKING_PATH_ENTRANCE_TRUE = BLOCKING_PATH -> TRUE
! -> BLOCKING_PATH_ENTRANCE_FALSE = BLOCKING_PATH -> FALSE

$ -> WHOS_THERE_DOOR_OPEN = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_OPEN / TALK_WHOS_THERE_DOOR_OPEN 
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_OPEN = GOTO -> TA_GO_TO_WORK, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> TALK_WHOS_THERE_DOOR_OPEN = TALK -> DOOR_WHOS_THERE_DOOR_OPEN
TALKED -> DOOR_WHOS_THERE_DOOR_OPEN = GOTO -> DOOR_IS_OPEN


//// I OPENING ////

$ -> TALK_DOOR_I_OPENING = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_I_OPENING / PARSE_DOOR_I_OPENING
$ -> PARSE_DOOR_I_OPENING = MEMORY -> SARAH_WAITING_OUTSIDE ? TALK:DOOR_I_OPENING_FOR_REAL / TALK:DOOR_I_OPENING
TALKED -> DOOR_I_OPENING_FOR_REAL = GOTO -> TA_NULL, TALK_DOOR_RIGHT_HAND
TALKED -> DOOR_I_OPENING = GOTO -> ENABLE_ONTHESPOT:2, TA_NULL, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_DOOR_RIGHT_HAND
TALKED -> DOOR_TOO_LATE_I_OPENING = GOTO -> ENABLE_ONTHESPOT:2, TA_NULL, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_DOOR_RIGHT_HAND

$ -> WHOS_THERE_DOOR_I_OPENING = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_I_OPENING / TALK_WHOS_THERE_DOOR_I_OPENING
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_I_OPENING = GOTO -> TA_RIGHT_HAND, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> TALK_WHOS_THERE_DOOR_I_OPENING = TALK -> DOOR_WHOS_THERE_I_OPENING
TALKED -> DOOR_WHOS_THERE_I_OPENING = GOTO -> ENABLE_ONTHESPOT:2, TA_NULL, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_DOOR_RIGHT_HAND


//// ONE MOMENT ////

$ -> TALK_JUST_A_MOMENT = GOTO -> TA_NULL, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_JUST_A_MOMENT_CONDITIONNAL
$ -> TALK_JUST_A_MOMENT_CONDITIONNAL = MEMORY -> KNOWING_KEY_POS ? DOOR_JUST_A_MOMENT_KNOWN_POS_CONDITIONNAL / DOOR_JUST_A_MOMENT_UNKNOWN_POS_CONDITIONNAL
$ -> DOOR_JUST_A_MOMENT_KNOWN_POS_CONDITIONNAL = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_JUST_A_MOMENT_KNOWN_POS / TALK:DOOR_JUST_A_MOMENT_KNOWN_POS
$ -> DOOR_JUST_A_MOMENT_UNKNOWN_POS_CONDITIONNAL = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_JUST_A_MOMENT_UNKNOWN_POS / TALK:DOOR_JUST_A_MOMENT_UNKNOWN_POS
TALKED -> DOOR_JUST_A_MOMENT_KNOWN_POS = GOTO -> TA_NULL
TALKED -> DOOR_TOO_LATE_JUST_A_MOMENT_KNOWN_POS = GOTO -> TA_NULL
TALKED -> DOOR_JUST_A_MOMENT_UNKNOWN_POS = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS
TALKED -> DOOR_TOO_LATE_JUST_A_MOMENT_UNKNOWN_POS = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS

$ -> WHOS_THERE_DOOR_JUST_A_MOMENT = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT / TALK_WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONNAL
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT = GOTO -> TA_NULL, A1_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> A1_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT = MEMORY -> KNOWING_KEY_POS ? ACTION_ONE:NULL / ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS
$ -> TALK_WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONNAL = MEMORY -> KNOWING_KEY_POS ? DOOR_WHOS_THERE_JUST_A_MOMENT_KNOWN_POS / DOOR_WHOS_THERE_JUST_A_MOMENT_UNKNOWN_POS
$ -> DOOR_WHOS_THERE_JUST_A_MOMENT_KNOWN_POS = GOTO -> TA_NULL, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK:DOOR_WHOS_THERE_JUST_A_MOMENT_KNOWN_POS
$ -> DOOR_WHOS_THERE_JUST_A_MOMENT_UNKNOWN_POS = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK:DOOR_WHOS_THERE_JUST_A_MOMENT_UNKNOWN_POS


//// FAKE OPEN ////

$ -> TALK_DOOR_FAKE_OPEN = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, DOOR_FAKE_OPEN_CONDITIONNAL
$ -> DOOR_FAKE_OPEN_CONDITIONNAL = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_FAKE_OPEN / TALK:DOOR_FAKE_OPEN
TALKED -> DOOR_TOO_LATE_FAKE_OPEN = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS
TALKED -> DOOR_FAKE_OPEN = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS

$ -> WHOS_THERE_DOOR_FAKE = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_FAKE / TALK_WHOS_THERE_DOOR_FAKE
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_FAKE = GOTO -> TA_INIT, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> TALK_WHOS_THERE_DOOR_FAKE = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS, AFFECTING:SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK:DOOR_WHOS_THERE_DOOR_FAKE
TALKED -> DOOR_WHOS_THERE_DOOR_FAKE = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS


//// MUCH LATER ////

! -> TOO_LATE_AT_DOOR = WAITFOR -> TIMER:16 ? RESET_DOOR_GO_TO_WORK, MEMORY:DOOR_MUCH_LATER, MUSIC:REBECCAS_ROOM
$ -> RESET_DOOR_GO_TO_WORK = MEMORY -> DOOR_OPENED ? TA_GO_TO_WORK / RESET_DOOR_RIGHT_HAND
$ -> RESET_DOOR_RIGHT_HAND = MEMORY -> KEY_FOUND ? TA_RIGHT_HAND / RESET_DOOR_NOTHING
$ -> RESET_DOOR_NOTHING = MEMORY -> KNOWING_KEY_POS ? TA_NULL / RESET_DOOR_THINK_ABOUT_LAST_KEY_POS
$ -> RESET_DOOR_THINK_ABOUT_LAST_KEY_POS = MEMORY -> KEY_LOST ? TA_THINK_ABOUT_LAST_KEY_POS / TA_INIT
$ -> TA_THINK_ABOUT_LAST_KEY_POS = TRIPLE_ACTION -> THINK*THINK_ABOUT_LAST_KEY_POS


//// SARAH INTERACTION ////

! -> SARAH_INTERACTION = GOTO -> TA_NULL
! -> SARAH_LEFT = GOTO -> TA_GO_TO_WORK
! -> SARAH_DEEP_SLEEP = ACTION_TWO -> LEAVE_WITHOUT_SARAH*GO_WITHOUT_SARAH
! -> SARAH_AWAKE_BACK = ACTION_TWO -> NULL


//// END LVL ////

$ -> GOTO_WORK = GOTO -> CUTSCENE:START, AFFECTING:MOVE_PLAYER_TO_EXIT_AFTER_DELAY, MUSIC:NULL, DELETE_ONTHESPOT:1
$ -> GO_WITHOUT_SARAH = GOTO -> CUTSCENE:START, SAVE_SEQUESTRATION, GOOD_DEED:DIDN'T_KILL_ANYONE, BAD_DEED:SEQUESTRATION, CREATE_WALL_BETTER_TRAJECTORY, MUSIC:ABSOLUTE_EVILNESS, WAITING_BEFORE_LEAVING
$ -> CREATE_WALL_BETTER_TRAJECTORY = CREATE -> 17-4-BACK:46-255-255
$ -> SAVE_SEQUESTRATION = SAVE -> REGISTER, REBECCAS_ROOM*SARAH_SEQUESTRATION
$ -> WAITING_BEFORE_LEAVING = WAITFOR -> TIMER:2 ? TALK:LEAVE_WITHOUT_SARAH
TALKED -> LEAVE_WITHOUT_SARAH = WAITFOR -> TIMER:1 ? MEMORY:STEAL_PHONE, AFFECTING:MOVE_PLAYER_TO_COUCH, DELETE_ONTHESPOT:1
