TIME -> 1 = GOTO -> NAME:DOOR, TA_INIT, DISABLE_ONTHESPOT:2


//// SET UP ////

$ -> TA_INIT = TRIPLE_ACTION -> OPEN*TALK_DOOR_MISSING_KEY
$ -> TA_NULL = TRIPLE_ACTION -> NULL


//// MISSING KEY ////

$ -> TALK_DOOR_MISSING_KEY = GOTO -> MEMORY:KEY_LOST, TALK:DOOR_MISSING_KEY
TALKED -> DOOR_MISSING_KEY = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS
! -> SEARCH_FOR_KEY = TALK -> DOOR_SEARCH
TALKED -> DOOR_SEARCH = GOTO -> AFFECTING:SEARCHING_KEY, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS
$ -> THINK_ABOUT_LAST_KEY_POS = AFFECTING -> OBJECT*THINK_ABOUT_LAST_KEY_POS
! -> THINK_ABOUT_LAST_KEY_POS = GOTO -> TA_NULL, MEMORY:KNOWING_KEY_POS, AFFECTING:KNOWING_KEY_POS, TALK:DOOR_THINK


//// FOUND KEY ////

! -> FAST_EXIT_POSSIBILITY =  WAITFOR -> TIMER:20 ? MEMORY:ACTIVATED_RIGHT_HAND_ADVISE
UNLOCKEDTOOL -> KEY:RED = GOTO -> MEMORY:KEY_FOUND, ENABLE_ONTHESPOT:2
UNLOCKEDTOOL -> KEY:CYAN = GOTO -> MEMORY:KEY_FOUND, ACTIVATED_RIGHT_HAND_ADVISE_CONDITIONNAL
$ -> ACTIVATED_RIGHT_HAND_ADVISE_CONDITIONNAL = MEMORY -> ACTIVATED_RIGHT_HAND_ADVISE ? PARSE_MUCH_LATER / ENABLE_ONTHESPOT:2, TA_NULL
$ -> PARSE_MUCH_LATER = MEMORY -> DOOR_MUCH_LATER ? TA_RIGHT_HAND / PARSE_BEFORE_VISIT
$ -> PARSE_BEFORE_VISIT = MEMORY -> VISITED ? AFFECTING:OBJECT*SOMEONE_JUST_KNOCKED / TA_RIGHT_HAND
$ -> TA_RIGHT_HAND = TRIPLE_ACTION -> OPEN*TALK_DOOR_RIGHT_HAND
$ -> TALK_DOOR_RIGHT_HAND = GAMEPAD -> TRUE ? OPENING_DOOR / TALK:DOOR_RIGHT_HAND
TALKED -> DOOR_RIGHT_HAND = GOTO -> OPENING_DOOR
$ -> OPENING_DOOR = GOTO -> ENABLE_ONTHESPOT:2, FACING_PLAYER:UP, OPEN_DOOR
$ -> OPEN_DOOR = OPEN_PUZZLE -> 6-1,1
WONPUZZLE -> 6-1 = GOTO -> A1_GO_TO_WORK_CONDITIONNAL, MEMORY:DOOR_OPENED, SARAH_ENTER_CONDITIONNAL
$ -> A1_GO_TO_WORK_CONDITIONNAL = NAME -> DOOR_TOWEL ? PARSE_GOTO_WORK_TOWEL / ACTION_ONE:GO_TO_WORK*GOTO_WORK
$ -> SARAH_ENTER_CONDITIONNAL = MEMORY -> SARAH_WAITING_OUTSIDE ? DOOR_IS_OPEN / NULL


//// REBECCA TOWEL ////

! -> NAME_PLAYER_REBECCA_TOWEL = GOTO -> NAME:DOOR_TOWEL, PARSE_DOOR_OPENED
! -> NAME_PLAYER_REBECCA = GOTO -> NAME:DOOR, PARSE_DOOR_OPENED
$ -> PARSE_DOOR_OPENED = MEMORY -> DOOR_OPENED ? PARSE_DEEP_SLEEP / NULL
$ -> PARSE_GOTO_WORK_TOWEL = MEMORY -> GOTO_WORK_TOWEL ? ACTION_ONE:NULL / ACTION_ONE:GO_TO_WORK*GOTO_WORK_TOWEL
$ -> GOTO_WORK_TOWEL = GOTO -> MEMORY:GOTO_WORK_TOWEL, TALK:GO_TO_WORK_TOWEL


//// SOMEONE KNOCKED ////

! -> SOMEONE_JUST_KNOCKED = GOTO -> DISABLE_ONTHESPOT:2, A1_OPEN_TO_SOMEONE_CONDITIONAL, PARSE_WHOS_THERE_ACTION
$ -> PARSE_WHOS_THERE_ACTION = MEMORY -> SARAH_WAITING_OUTSIDE ? NULL / ACTION_TWO:WHOS_THERE*WHOS_THERE_CONDITIONAL
$ -> A1_OPEN_TO_SOMEONE_CONDITIONAL = MEMORY -> DOOR_OPENED ? ACTION_ONE:OPEN*DOOR_IS_OPEN / DOOR_I_OPENING
$ -> DOOR_I_OPENING = MEMORY -> KEY_FOUND ? ACTION_ONE:OPEN*TALK_DOOR_I_OPENING / DOOR_JUST_A_MOMENT
$ -> DOOR_JUST_A_MOMENT = MEMORY -> KEY_LOST ? ACTION_ONE:JUST_A_MOMENT*TALK_JUST_A_MOMENT / ACTION_ONE:OPEN*TALK_DOOR_FAKE_OPEN

$ -> WHOS_THERE_CONDITIONAL = MEMORY -> DOOR_OPENED ? WHOS_THERE_DOOR_OPEN / WHOS_THERE_DOOR_I_OPENING_CONDITIONAL
$ -> WHOS_THERE_DOOR_I_OPENING_CONDITIONAL = MEMORY -> KEY_FOUND ? WHOS_THERE_DOOR_I_OPENING / WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONAL
$ -> WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONAL = MEMORY -> KEY_LOST ? WHOS_THERE_DOOR_JUST_A_MOMENT / WHOS_THERE_DOOR_FAKE


//// OPEN DOOR ////

$ -> DOOR_IS_OPEN = GOTO -> CUTSCENE:START, A1_GO_TO_WORK_CONDITIONNAL, PLAYER_SIDE_STEP
$ -> PLAYER_SIDE_STEP = GOTO -> AFFECTING:SARAH*SARAH_STOP_KNOCKING, FACING_PLAYER:UP, WAITING_BEFORE_SIDE_STEP
$ -> WAITING_BEFORE_SIDE_STEP = WAITFOR -> TIMER:1 ? AFFECTING:ADD_ENTRANCE_WATER, AFFECTING:PLAYER*MOVE_PLAYER_TO_SIDE_STEP_ENTRANCE
! -> PLAYER_REACHED_SIDE_STEP_ENTRANCE = WAITFOR -> TIMER:1 ? PARSE_DODGED_HUG 
$ -> PARSE_DODGED_HUG = MEMORY -> SARAH_ENTERED ? NULL / TALK:DOOR_IS_OPEN, BLOCKING_PATH:FALSE, AFFECTING:SARAH*SARAH_ENTER
! -> BLOCKING_PATH_ENTRANCE_TRUE = BLOCKING_PATH -> TRUE
! -> BLOCKING_PATH_ENTRANCE_FALSE = BLOCKING_PATH -> FALSE

$ -> WHOS_THERE_DOOR_OPEN = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_OPEN / TALK_WHOS_THERE_DOOR_OPEN 
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_OPEN = GOTO -> A1_GO_TO_WORK_CONDITIONNAL, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> TALK_WHOS_THERE_DOOR_OPEN = TALK -> DOOR_WHOS_THERE_DOOR_OPEN
TALKED -> DOOR_WHOS_THERE_DOOR_OPEN = GOTO -> DOOR_IS_OPEN


//// I OPENING ////

$ -> TALK_DOOR_I_OPENING = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_I_OPENING / PARSE_DOOR_I_OPENING
$ -> PARSE_DOOR_I_OPENING = MEMORY -> SARAH_WAITING_OUTSIDE ? TALK:DOOR_I_OPENING_FOR_REAL / TALK:DOOR_I_OPENING
TALKED -> DOOR_I_OPENING_FOR_REAL = GOTO -> TA_NULL, TALK_DOOR_RIGHT_HAND
TALKED -> DOOR_I_OPENING = GOTO -> ENABLE_ONTHESPOT:2, TA_NULL, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_DOOR_RIGHT_HAND
TALKED -> DOOR_TOO_LATE_I_OPENING = GOTO -> ENABLE_ONTHESPOT:2, TA_NULL, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_DOOR_RIGHT_HAND

$ -> WHOS_THERE_DOOR_I_OPENING = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_I_OPENING / TALK_WHOS_THERE_DOOR_I_OPENING
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_I_OPENING = GOTO -> TA_RIGHT_HAND, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> TALK_WHOS_THERE_DOOR_I_OPENING = TALK -> DOOR_WHOS_THERE_I_OPENING
TALKED -> DOOR_WHOS_THERE_I_OPENING = GOTO -> ENABLE_ONTHESPOT:2, TA_NULL, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_DOOR_RIGHT_HAND


//// ONE MOMENT ////

$ -> TALK_JUST_A_MOMENT = GOTO -> TA_NULL, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK_JUST_A_MOMENT_CONDITIONNAL
$ -> TALK_JUST_A_MOMENT_CONDITIONNAL = MEMORY -> KNOWING_KEY_POS ? DOOR_JUST_A_MOMENT_KNOWN_POS_CONDITIONNAL / DOOR_JUST_A_MOMENT_UNKNOWN_POS_CONDITIONNAL
$ -> DOOR_JUST_A_MOMENT_KNOWN_POS_CONDITIONNAL = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_JUST_A_MOMENT_KNOWN_POS / TALK:DOOR_JUST_A_MOMENT_KNOWN_POS
$ -> DOOR_JUST_A_MOMENT_UNKNOWN_POS_CONDITIONNAL = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_JUST_A_MOMENT_UNKNOWN_POS / TALK:DOOR_JUST_A_MOMENT_UNKNOWN_POS
TALKED -> DOOR_JUST_A_MOMENT_KNOWN_POS = GOTO -> TA_NULL
TALKED -> DOOR_TOO_LATE_JUST_A_MOMENT_KNOWN_POS = GOTO -> TA_NULL
TALKED -> DOOR_JUST_A_MOMENT_UNKNOWN_POS = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS
TALKED -> DOOR_TOO_LATE_JUST_A_MOMENT_UNKNOWN_POS = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS

$ -> WHOS_THERE_DOOR_JUST_A_MOMENT = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT / TALK_WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONNAL
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT = GOTO -> TA_NULL, A1_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> A1_TOO_LATE_WHOS_THERE_DOOR_JUST_A_MOMENT = MEMORY -> KNOWING_KEY_POS ? ACTION_ONE:NULL / ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS
$ -> TALK_WHOS_THERE_DOOR_JUST_A_MOMENT_CONDITIONNAL = MEMORY -> KNOWING_KEY_POS ? DOOR_WHOS_THERE_JUST_A_MOMENT_KNOWN_POS / DOOR_WHOS_THERE_JUST_A_MOMENT_UNKNOWN_POS
$ -> DOOR_WHOS_THERE_JUST_A_MOMENT_KNOWN_POS = GOTO -> TA_NULL, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK:DOOR_WHOS_THERE_JUST_A_MOMENT_KNOWN_POS
$ -> DOOR_WHOS_THERE_JUST_A_MOMENT_UNKNOWN_POS = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK:DOOR_WHOS_THERE_JUST_A_MOMENT_UNKNOWN_POS


//// FAKE OPEN ////

$ -> TALK_DOOR_FAKE_OPEN = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, DOOR_FAKE_OPEN_CONDITIONNAL
$ -> DOOR_FAKE_OPEN_CONDITIONNAL = MEMORY -> BUT_NOBODY_CAME ? TALK:DOOR_TOO_LATE_FAKE_OPEN / TALK:DOOR_FAKE_OPEN
TALKED -> DOOR_TOO_LATE_FAKE_OPEN = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS
TALKED -> DOOR_FAKE_OPEN = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS

$ -> WHOS_THERE_DOOR_FAKE = MEMORY -> BUT_NOBODY_CAME ? TALK_TOO_LATE_WHOS_THERE_DOOR_FAKE / TALK_WHOS_THERE_DOOR_FAKE
$ -> TALK_TOO_LATE_WHOS_THERE_DOOR_FAKE = GOTO -> TA_INIT, TALK:DOOR_TOO_LATE_WHOS_THERE
$ -> TALK_WHOS_THERE_DOOR_FAKE = GOTO -> TA_NULL, ACTION_ONE:THINK*THINK_ABOUT_LAST_KEY_POS, AFFECTING:SARAH*SARAH_STOP_KNOCKING, MEMORY:SARAH_WAITING_OUTSIDE, TALK:DOOR_WHOS_THERE_DOOR_FAKE
TALKED -> DOOR_WHOS_THERE_DOOR_FAKE = CHOICE -> SEARCH*SEARCH_FOR_KEY, THINK*THINK_ABOUT_LAST_KEY_POS


//// MUCH LATER ////

TALKED -> DOOR_TOO_LATE_OPEN = MUSIC -> REBECCAS_ROOM
TALKED -> DOOR_TOO_LATE_WHOS_THERE = MUSIC -> REBECCAS_ROOM
! -> TOO_LATE_AT_DOOR = WAITFOR -> TIMER:16 ? RESET_DOOR_GO_TO_WORK, MEMORY:DOOR_MUCH_LATER, MUSIC:REBECCAS_ROOM, SAVE_REBECCA_IGNORED_DOOR
$ -> RESET_DOOR_GO_TO_WORK = MEMORY -> DOOR_OPENED ? A1_GO_TO_WORK_CONDITIONNAL / RESET_DOOR_RIGHT_HAND
$ -> RESET_DOOR_RIGHT_HAND = MEMORY -> KEY_FOUND ? TA_RIGHT_HAND / RESET_DOOR_NOTHING
$ -> RESET_DOOR_NOTHING = MEMORY -> KNOWING_KEY_POS ? TA_NULL / RESET_DOOR_THINK_ABOUT_LAST_KEY_POS
$ -> RESET_DOOR_THINK_ABOUT_LAST_KEY_POS = MEMORY -> KEY_LOST ? TA_THINK_ABOUT_LAST_KEY_POS / TA_INIT
$ -> TA_THINK_ABOUT_LAST_KEY_POS = TRIPLE_ACTION -> THINK*THINK_ABOUT_LAST_KEY_POS
$ -> SAVE_REBECCA_IGNORED_DOOR = SAVE -> REGISTER, REBECCA*IGNORED_DOOR


//// SARAH INTERACTION ////

! -> SARAH_INTERACTION = GOTO -> TA_NULL
! -> SARAH_LEFT = GOTO -> ACTION_ONE:NULL, A1_GO_TO_WORK_CONDITIONNAL
! -> SARAH_DEEP_SLEEP = NAME -> DOOR ? A1_GO_WITHOUT_SARAH / ACTION_ONE:NULL
! -> SARAH_AWAKE_BACK = GOTO -> TA_NULL
$ -> A1_GO_WITHOUT_SARAH = NAME -> DOOR ? ACTION_ONE:LEAVE_WITHOUT_SARAH*GO_WITHOUT_SARAH / ACTION_ONE:NULL

$ -> PARSE_DEEP_SLEEP = MEMORY -> SARAH_DEEP_SLEEP ? PARSE_WAKE_UP / PARSE_SARAH_INTERACTION
$ -> PARSE_WAKE_UP = MEMORY -> SARAH_AWAKE ? PARSE_SECOND_SLEEP / A1_GO_WITHOUT_SARAH
$ -> PARSE_SECOND_SLEEP = MEMORY -> SECOND_SLEEP ? A1_GO_WITHOUT_SARAH / ACTION_ONE:NULL
$ -> PARSE_SARAH_INTERACTION = MEMORY -> SARAH_INTERACTION ? PARSE_SARAH_LEFT / A1_GO_TO_WORK_CONDITIONNAL
$ -> PARSE_SARAH_LEFT = MEMORY -> SARAH_LEFT ? A1_GO_TO_WORK_CONDITIONNAL / NULL


//// END LVL ////

$ -> GOTO_WORK = GOTO -> CUTSCENE:START, AFFECTING:ADD_ENTRANCE_WATER, AFFECTING:PLAYER*MOVE_PLAYER_TO_EXIT_AFTER_DELAY, MUSIC:NULL, DELETE_ONTHESPOT:1
$ -> GO_WITHOUT_SARAH = GOTO -> CUTSCENE:START, COUNTER_SEQUESTRATION, AFFECTING:ADD_ENTRANCE_WATER, SAVE_SEQUESTRATION, UNSAVE_REBECCA_ARRIVE_AFTER_SARAH, GOOD_DEED:NO_KILL, BAD_DEED:FORCED_CONFINEMENT, CREATE_WALL_BETTER_TRAJECTORY, MUSIC:ABSOLUTE_EVILNESS, WAITING_BEFORE_LEAVING
$ -> COUNTER_SEQUESTRATION = COUNTER_THREE -> ADD, 1
$ -> CREATE_WALL_BETTER_TRAJECTORY = CREATE -> 17-4-BACK:46-255-255
$ -> SAVE_SEQUESTRATION = SAVE -> REGISTER, PSYCOPATH*SARAH_SEQUESTRATION
$ -> UNSAVE_REBECCA_ARRIVE_AFTER_SARAH = SAVE -> CANCEL_REGISTER, LABORATORY*REBECCA_ARRIVE_AFTER_SARAH
$ -> WAITING_BEFORE_LEAVING = WAITFOR -> TIMER:2 ? PARSE_PANCAKES
$ -> PARSE_PANCAKES = MEMORY -> PANCAKES ? PAST_SMELL_ONLY / TALK:LEAVE_WITHOUT_SARAH
$ -> PAST_SMELL_ONLY = MEMORY -> PANCAKES_SMELL_ONLY ? TALK:LEAVE_WITHOUT_SARAH / TALK:LEAVE_WITHOUT_SARAH_PANCAKES
TALKED -> LEAVE_WITHOUT_SARAH = WAITFOR -> TIMER:1 ? GO_STEALING_PHONE
TALKED -> LEAVE_WITHOUT_SARAH_PANCAKES = GOTO -> MEMORY:DUMP_PANCAKES, AFFECTING:PLAYER*MOVE_PLAYER_TO_PANCAKES_TABLE
! -> PLAYER_REACHED_PANCAKES_TABLE_DUMPING = WAITFOR -> TIMER:1 ? SOUND:PLATE, DELETE_PANCAKES, WAITING_BEFORE_MOVE_PLAYER_TO_TRASH
$ -> DELETE_PANCAKES = GOTO -> DELETE_LEFT_PANCAKES, DELETE_TOP_PANCAKES_CONDITIONNAL
$ -> DELETE_TOP_PANCAKES_CONDITIONNAL = MEMORY -> SHARED_PANCAKES ? DELETE_TOP_PANCAKES / NULL
$ -> DELETE_LEFT_PANCAKES = DELETE -> 8-3:WORLD,1
$ -> DELETE_TOP_PANCAKES = DELETE -> 9-3:WORLD,1
$ -> CREATE_PANCAKES_IN_TRASH = CREATE_DECORATION -> 4-5-FRONT:WORLD,1,1,PANCAKES_04
$ -> WAITING_BEFORE_MOVE_PLAYER_TO_TRASH = WAITFOR -> TIMER:1 ? AFFECTING:PLAYER*MOVE_PLAYER_TO_TRASH
! -> PLAYER_REACHED_TRASH = WAITFOR -> TIMER:1 ? SAVE_PANCAKES_IN_TRASH, MUTLI_UNSAVE_PANCAKES_ON_TABLE, CREATE_PANCAKES_IN_TRASH, SOUND:SLIME, WAITING_BEFORE_TALKING_TRASH
$ -> SAVE_PANCAKES_IN_TRASH = SAVE -> REGISTER, REBECCAS_ROOM*PANCAKES_IN_TRASH
$ -> MUTLI_UNSAVE_PANCAKES_ON_TABLE = GOTO -> UNSAVE_PANCAKES_ON_TABLE, UNSAVE_LEFT_PANCAKES_ON_TABLE, UNSAVE_UP_PANCAKES_ON_TABLE
$ -> UNSAVE_PANCAKES_ON_TABLE = SAVE -> CANCEL_REGISTER, REBECCAS_ROOM*PANCAKES_ON_TABLE
$ -> UNSAVE_LEFT_PANCAKES_ON_TABLE = SAVE -> CANCEL_REGISTER, REBECCAS_ROOM*LEFT_PANCAKES_ON_TABLE
$ -> UNSAVE_UP_PANCAKES_ON_TABLE = SAVE -> CANCEL_REGISTER, REBECCAS_ROOM*UP_PANCAKES_ON_TABLE
$ ->  WAITING_BEFORE_TALKING_TRASH = WAITFOR -> TIMER:1 ? TALK:LEAVE_WITHOUT_SARAH_TRASH
TALKED -> LEAVE_WITHOUT_SARAH_TRASH = WAITFOR -> TIMER:1 ? GO_STEALING_PHONE
$ -> GO_STEALING_PHONE = GOTO -> MEMORY:STEAL_PHONE, AFFECTING:PLAYER*MOVE_PLAYER_TO_COUCH, DELETE_ONTHESPOT:1
